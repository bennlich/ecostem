<html>
  <head>
    <title>LiveTile Test</title>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF8">

    <link rel="stylesheet" type="text/css" href="lib/leaflet/leaflet.css"/>
    <link rel="stylesheet" type="text/css" href="css/ecostem.css"/>
    <link rel="stylesheet" type="text/css" href="css/svg.css"/>

    <script src="https://cdn.firebase.com/js/client/1.0.2/firebase.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>

    <script src="lib/agentscript.js"></script>
    <script src="lib/data.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/jquery-1.10.2.js"></script>
    <script src="lib/jquery.event.drag-2.2/jquery.event.drag-2.2.js"></script>
    <script src="lib/leaflet/leaflet-src.js"></script>
    <script src="lib/angular/angular.js"></script>
    <script src="lib/angular/angular-route.js"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/Smooth-0.1.7.js"></script>
    <script src="lib/curveFit.js"></script>
    <script src="lib/Google.js"></script>

    <script src="js/Util.js"></script>

    <script>
      $(document).ready(function() {
        var fb = new Firebase("https://simtable.firebaseio.com/nnmc/livetiles");

        var map = new L.Map('map',{
          minZoom: 3, 
          maxZoom: 15
        });

        map.setView(new L.LatLng(35.68832407198268, -105.91811656951903), 12);
        map.addLayer(new L.Google('TERRAIN'));

        var liveLayer = new L.tileLayer.canvas({zIndex:10});
        liveLayer.drawTile = function(canvas, tilePoint, zoom) {
          var ctx = canvas.getContext('2d');
          var handle = '{0}_{1}_{2}'.format(zoom, tilePoint.x, tilePoint.y);

          var img = new Image();

          fb.child('listen').set(handle);
          fb.child(handle).on('value', function(data) {
            var base64 = data.val();
            if (!base64)
              return;

            img.src = base64;
            img.onload = function() {
              ctx.clearRect(0,0,canvas.width,canvas.height);
              ctx.drawImage(img, 0, 0);
            };
          });

          map.on('zoomstart', function() {
            fb.child('stopListening').set(handle);
          });
        };

        map.addLayer(liveLayer);
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div id="map"></div>
    </div>
  </body>
</html>
